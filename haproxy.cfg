global
    log stdout format raw local0 info
    maxconn 4096

defaults
    log     global
    mode    tcp
    option  tcplog
    option  dontlognull
    timeout connect 10s
    timeout client  300s
    timeout server  300s

# ============================================
# 场景1: TCP 代理 - PROXY Protocol v2
# 节点A 连 127.0.0.1:18115 -> haproxy -> 127.0.0.1:8115 (节点B)
# ============================================
frontend tcp_proxy
    bind *:18115
    default_backend tcp_backend

backend tcp_backend
    server ckb 127.0.0.1:8115 send-proxy-v2

# ============================================
# 场景2: TCP 代理 - PROXY Protocol v1
# 节点D 连 127.0.0.1:18116 -> haproxy -> 127.0.0.1:8115 (节点B)
# ============================================
frontend tcp_proxy_v1
    bind *:18116
    default_backend tcp_backend_v1

backend tcp_backend_v1
    server ckb 127.0.0.1:8115 send-proxy

# ============================================
# 场景3: WebSocket 代理 - X-Forwarded-For
# 节点A 连 ws://127.0.0.1:18080 -> haproxy -> 127.0.0.1:8115 (节点B)
# ============================================
frontend ws_proxy
    bind *:18080
    mode http
    default_backend ws_backend

backend ws_backend
    mode http
    option forwardfor
    http-request set-header X-Forwarded-Port %[src_port]
    server ckb 127.0.0.1:8115

# ============================================
# 场景4: TCP 代理 - 无 Proxy Protocol（向后兼容测试）
# 节点E 连 127.0.0.1:18117 -> haproxy -> 127.0.0.1:8115 (节点B)
# 验证: 经过代理但不加任何协议头，连接应正常工作，
#       只是节点B看到的 IP/端口 是 HAProxy 的，不是真实客户端的
# ============================================
frontend tcp_proxy_plain
    bind *:18117
    default_backend tcp_backend_plain

backend tcp_backend_plain
    server ckb 127.0.0.1:8115
