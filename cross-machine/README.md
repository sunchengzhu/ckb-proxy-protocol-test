# CKB Proxy Protocol è·¨æœºæµ‹è¯•

è·¨æœºç‰ˆæœ¬çš„ CKB Proxy Protocol æµ‹è¯•ï¼ŒéªŒè¯ [ckb#5105](https://github.com/nervosnetwork/ckb/pull/5105)ã€‚

ä¸åŒæœºæµ‹è¯•çš„åŒºåˆ«ï¼š
- HAProxy åœ¨ Ubuntu ä¸Š**åŸç”Ÿè¿è¡Œ**ï¼ˆä¸ç”¨ Dockerï¼‰
- èŠ‚ç‚¹åˆ†å¸ƒåœ¨**ä¸¤å°æœºå™¨**ä¸Šï¼Œå¯ä»¥çœŸæ­£éªŒè¯ IP ä¼ é€’
- X-Forwarded-For çš„ IP éªŒè¯åœ¨åŒæœºç¯å¢ƒä¸‹æ˜¯å¼±éªŒè¯ï¼Œè·¨æœºç¯å¢ƒä¸‹å¯ä»¥**å¼ºéªŒè¯**

## æ¶æ„

```
  å®¢æˆ·ç«¯æœºå™¨ (CLIENT_IP)            æœåŠ¡ç«¯æœºå™¨ (SERVER_IP)
  +---------------------+          +---------------------------+
  | èŠ‚ç‚¹ A (TCP, P2P:8116) ----TCP---->| HAProxy :8230             |
  |                     |          |   send-proxy-v2 -> :8115  |
  | èŠ‚ç‚¹ D (TCP, P2P:8118) ----TCP---->| HAProxy :8232             |
  |                     |          |   send-proxy v1 -> :8115  |-->  èŠ‚ç‚¹ B
  | èŠ‚ç‚¹ E (TCP, P2P:8119) ----TCP---->| HAProxy :8233             |    P2P:8115
  |                     |          |   çº¯ TCP è½¬å‘ -> :8115    |    RPC:8114
  | èŠ‚ç‚¹ C (WS,  P2P:8117) ----WS---->| HAProxy :8231             |
  |                     |          |   X-Fwd-For/Port -> :8115 |
  +---------------------+          +---------------------------+
```

## å‰ç½®æ¡ä»¶

**ä¸¤å°æœºå™¨éƒ½éœ€è¦:**
- CKB äºŒè¿›åˆ¶ï¼ˆåŒ…å« PR #5105 çš„ä»£ç ï¼‰
- curl, jq

**æœåŠ¡ç«¯é¢å¤–éœ€è¦:**
- HAProxy: `sudo apt update && sudo apt install -y haproxy`

**ç½‘ç»œè¦æ±‚:**
- å®¢æˆ·ç«¯èƒ½è®¿é—®æœåŠ¡ç«¯çš„ **8114** (RPC)ã€**8230** (TCP v2 ä»£ç†)ã€**8231** (WS ä»£ç†)ã€**8232** (TCP v1 ä»£ç†)ã€**8233** (TCP æ— åè®®ä»£ç†) ç«¯å£
- å¦‚æœ‰é˜²ç«å¢™ / AWS Security Groupï¼Œéœ€æ”¾è¡Œè¿™äº”ä¸ªç«¯å£

## ç«¯å£åˆ†é…

| ç»„ä»¶ | æ‰€åœ¨æœºå™¨ | ç«¯å£ | è¯´æ˜ |
|------|---------|------|------|
| èŠ‚ç‚¹ B (P2P) | æœåŠ¡ç«¯ | 8115 | æ¥æ”¶ä»£ç†è¿æ¥ |
| èŠ‚ç‚¹ B (RPC) | æœåŠ¡ç«¯ | 8114 | ç›‘å¬ 0.0.0.0ï¼Œè¿œç¨‹å¯è®¿é—® |
| HAProxy TCP v2 | æœåŠ¡ç«¯ | 8230 | send-proxy-v2 -> :8115 |
| HAProxy TCP v1 | æœåŠ¡ç«¯ | 8232 | send-proxy (v1) -> :8115 |
| HAProxy TCP æ— åè®® | æœåŠ¡ç«¯ | 8233 | çº¯ TCP è½¬å‘ -> :8115ï¼ˆå‘åå…¼å®¹æµ‹è¯•ï¼‰ |
| HAProxy WS | æœåŠ¡ç«¯ | 8231 | X-Forwarded-For/Port -> :8115 |
| èŠ‚ç‚¹ A (P2P) | å®¢æˆ·ç«¯ | 8116 | TCP/PP v2 å®¢æˆ·ç«¯ |
| èŠ‚ç‚¹ A (RPC) | å®¢æˆ·ç«¯ | 8124 | æœ¬åœ° RPC |
| èŠ‚ç‚¹ D (P2P) | å®¢æˆ·ç«¯ | 8118 | TCP/PP v1 å®¢æˆ·ç«¯ |
| èŠ‚ç‚¹ D (RPC) | å®¢æˆ·ç«¯ | 8144 | æœ¬åœ° RPC |
| èŠ‚ç‚¹ E (P2P) | å®¢æˆ·ç«¯ | 8119 | TCP æ— åè®®å®¢æˆ·ç«¯ |
| èŠ‚ç‚¹ E (RPC) | å®¢æˆ·ç«¯ | 8154 | æœ¬åœ° RPC |
| èŠ‚ç‚¹ C (P2P) | å®¢æˆ·ç«¯ | 8117 | WS å®¢æˆ·ç«¯ |
| èŠ‚ç‚¹ C (RPC) | å®¢æˆ·ç«¯ | 8134 | æœ¬åœ° RPC |

## ä½¿ç”¨æ–¹æ³•

### ç¬¬ 1 æ­¥ï¼šæœåŠ¡ç«¯è®¾ç½®

åœ¨æœåŠ¡ç«¯æœºå™¨ä¸Šï¼š

```bash
cd cross-machine/server

# é…ç½® CKB è·¯å¾„
echo 'CKB_BIN=/path/to/ckb' > .env

# åˆå§‹åŒ–
bash setup.sh

# å¯åŠ¨
bash start.sh
```

è®°ä¸‹è¾“å‡ºçš„ `peer_id`ï¼Œä¸‹ä¸€æ­¥è¦ç”¨ã€‚

### ç¬¬ 2 æ­¥ï¼šä¼ é€’æ–‡ä»¶åˆ°å®¢æˆ·ç«¯

å°†æœåŠ¡ç«¯çš„ peer_id å’Œ dev.toml ä¼ åˆ°å®¢æˆ·ç«¯ï¼š

```bash
# åœ¨æœåŠ¡ç«¯æ‰§è¡Œ
scp server/.node_b_peer_id  user@CLIENT_IP:cross-machine/client/.node_b_peer_id
scp server/node_b/specs/dev.toml  user@CLIENT_IP:cross-machine/client/.dev.toml
```

æˆ–è€…æ‰‹åŠ¨åˆ›å»ºï¼š

```bash
# åœ¨å®¢æˆ·ç«¯æ‰§è¡Œ
echo '<ä¸Šä¸€æ­¥çœ‹åˆ°çš„ peer_id>' > client/.node_b_peer_id
```

### ç¬¬ 3 æ­¥ï¼šå®¢æˆ·ç«¯è®¾ç½®

åœ¨å®¢æˆ·ç«¯æœºå™¨ä¸Šï¼š

```bash
cd cross-machine/client

# é…ç½®æœåŠ¡ç«¯ IP å’Œ CKB è·¯å¾„
cat > .env << 'EOF'
SERVER_IP=<æœåŠ¡ç«¯IP>
CKB_BIN=/path/to/ckb
EOF

# åˆå§‹åŒ–
bash setup.sh

# å¯åŠ¨
bash start.sh
```

### ç¬¬ 4 æ­¥ï¼šæ£€æŸ¥ç»“æœ

åœ¨å®¢æˆ·ç«¯æœºå™¨ä¸Šè¿è¡Œï¼ˆè„šæœ¬ä¼šè‡ªåŠ¨ä» `client/.env` è¯»å– `SERVER_IP`ï¼‰ï¼š

```bash
cd cross-machine
bash check.sh
```

### åœæ­¢

```bash
# å®¢æˆ·ç«¯
cd cross-machine/client && bash stop.sh

# æœåŠ¡ç«¯
cd cross-machine/server && bash stop.sh
```

## æ£€æŸ¥é¡¹ç›®

| æ£€æŸ¥ | å†…å®¹ | é€šè¿‡æ¡ä»¶ |
|------|------|----------|
| æ£€æŸ¥ 1 | peer è¿æ¥ | èŠ‚ç‚¹ B æœ‰è‡³å°‘ 4 ä¸ª peer |
| æ£€æŸ¥ 3 | åŒºå—åŒæ­¥ | äº”ä¸ªèŠ‚ç‚¹ tip ä¸€è‡´ |
| æ£€æŸ¥ 4a | TCP v2 IP | èŠ‚ç‚¹ B çœ‹åˆ°å®¢æˆ·ç«¯çœŸå® IP (PP v2) |
| æ£€æŸ¥ 4b | TCP v2 ç«¯å£ | ç«¯å£é HAProxy ä»£ç†ç«¯å£ 8230 |
| æ£€æŸ¥ 4c | TCP v1 IP | èŠ‚ç‚¹ B çœ‹åˆ°å®¢æˆ·ç«¯çœŸå® IP (PP v1) |
| æ£€æŸ¥ 4d | TCP v1 ç«¯å£ | ç«¯å£é HAProxy ä»£ç†ç«¯å£ 8232 |
| æ£€æŸ¥ 4e | TCP æ— åè®® | èŠ‚ç‚¹ E é€šè¿‡æ— åè®®ä»£ç†æˆåŠŸè¿æ¥èŠ‚ç‚¹ B |
| æ£€æŸ¥ 5 | WS IP | èŠ‚ç‚¹ B çœ‹åˆ°å®¢æˆ·ç«¯çœŸå® IP (X-Forwarded-For) |
| æ£€æŸ¥ 6 | WS ç«¯å£ | èŠ‚ç‚¹ C æºç«¯å£ == èŠ‚ç‚¹ B çœ‹åˆ°çš„ç«¯å£ (X-Forwarded-Port) |
| æ£€æŸ¥ 7 | IP ä¸€è‡´æ€§ | TCP v2 / TCP v1 / WS è·¯å¾„çœ‹åˆ°çš„å®¢æˆ·ç«¯ IP ç›¸åŒ |

### è·¨æœº vs åŒæœºçš„å…³é”®åŒºåˆ«

| éªŒè¯é¡¹ | åŒæœº | è·¨æœº |
|--------|------|------|
| X-Forwarded-For (IP) | âš ï¸ å¼±éªŒè¯ï¼ˆsocket IP == forwarded IPï¼‰ | âœ… **å¼ºéªŒè¯**ï¼ˆIP å¿…é¡»æ˜¯å®¢æˆ·ç«¯æœºå™¨çš„çœŸå® IPï¼‰ |
| X-Forwarded-Port (ç«¯å£) | âš ï¸ é—´æ¥éªŒè¯ï¼ˆsocket ç«¯å£äº¤å‰æ¯”å¯¹ï¼‰ | âœ… **ç²¾ç¡®åŒ¹é…**ï¼ˆ`ss` æŸ¥åˆ°çš„æºç«¯å£ == `get_peers` ç«¯å£ï¼‰ |
| Proxy Protocol v2 (IP) | âš ï¸ å¼±éªŒè¯ï¼ˆDocker ç½‘å…³ IPï¼‰ | âœ… **å¼ºéªŒè¯**ï¼ˆIP å¿…é¡»æ˜¯å®¢æˆ·ç«¯ IPï¼‰ |
| Proxy Protocol v1 (IP) | âš ï¸ å¼±éªŒè¯ï¼ˆDocker ç½‘å…³ IPï¼‰ | âœ… **å¼ºéªŒè¯**ï¼ˆIP å¿…é¡»æ˜¯å®¢æˆ·ç«¯ IPï¼‰ |

## é¢„æœŸè¾“å‡ºç¤ºä¾‹

```
CKB Proxy Protocol è·¨æœºæµ‹è¯•æ£€æŸ¥
  æœåŠ¡ç«¯: 10.0.1.100
  å®¢æˆ·ç«¯: 10.0.1.200

æ£€æŸ¥ 4: TCP è·¯å¾„ â€” Proxy Protocol v2
  [4a] Proxy Protocol v2 â€” IP ä¼ é€’:
    âœ… PASS: IP=10.0.1.200 æ˜¯å®¢æˆ·ç«¯æœºå™¨çš„çœŸå® IP
  [4b] Proxy Protocol v2 â€” ç«¯å£ä¼ é€’:
    âœ… PASS: ç«¯å£ 45678 æ˜¯éšæœºæºç«¯å£ï¼ˆé 8230ï¼‰

æ£€æŸ¥ 4c/4d: TCP è·¯å¾„ â€” Proxy Protocol v1
  [4c] Proxy Protocol v1 â€” IP ä¼ é€’:
    âœ… PASS: IP=10.0.1.200 æ˜¯å®¢æˆ·ç«¯æœºå™¨çš„çœŸå® IP
  [4d] Proxy Protocol v1 â€” ç«¯å£ä¼ é€’:
    âœ… PASS: ç«¯å£ 51234 æ˜¯éšæœºæºç«¯å£ï¼ˆé 8232ï¼‰

æ£€æŸ¥ 4e: TCP è·¯å¾„ â€” æ— åè®®ï¼ˆå‘åå…¼å®¹ï¼‰
  âœ… PASS: èŠ‚ç‚¹ E é€šè¿‡æ— åè®® TCP ä»£ç†æˆåŠŸè¿æ¥åˆ°èŠ‚ç‚¹ B
     -> Proxy Protocol åŠŸèƒ½æœªç ´åæ™®é€š TCP è¿æ¥çš„å‘åå…¼å®¹æ€§

æ£€æŸ¥ 5: WS è·¯å¾„ â€” X-Forwarded-For (IP)
  âœ… PASS: IP=10.0.1.200 æ˜¯å®¢æˆ·ç«¯æœºå™¨çš„çœŸå® IP

æ£€æŸ¥ 6: WS è·¯å¾„ â€” X-Forwarded-Port (ç«¯å£)
  èŠ‚ç‚¹ B æŠ¥å‘Šçš„ç«¯å£ (get_peers): 52341
  èŠ‚ç‚¹ C åˆ° HAProxy çš„å®é™…æºç«¯å£ (ss): 52341
  âœ… PASS: ç«¯å£å®Œå…¨åŒ¹é…ï¼

æ£€æŸ¥ 7: TCP(v2) / TCP(v1) / WS è·¯å¾„ IP ä¸€è‡´æ€§
  âœ… PASS: ä¸‰æ¡è·¯å¾„çœ‹åˆ°çš„ IP ä¸€è‡´ (10.0.1.200)

æµ‹è¯•æ€»ç»“
  é€šè¿‡: 10
  å¤±è´¥: 0
  ğŸ‰ æ‰€æœ‰æ£€æŸ¥é€šè¿‡ï¼
```
